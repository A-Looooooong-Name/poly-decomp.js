<!DOCTYPE html>
<html>
<head>
<style>
    body {
        margin: 0px;
        padding: 0px;
        overflow: hidden;
    }
    canvas {
        position:absolute;
        top:0;
        left:0;
    }
</style>
</head>
<body>
    <h1>poly-decomp.js</h1>
    <p>Decomposition of 2D polygons into convex pieces in JavaScript.</p>
    <p>Try drawing a polygon!</p>

    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="build/decomp.js"></script>
    <script src="dat.gui.js"></script>
    <script>
    var path = [],
        polys = [],
        mousedown = false,
        colors = ["#f99","#9f9","#99f","#ff9"];

    var canvas = document.createElement('canvas');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    document.body.appendChild(canvas);

    function render() {
        var c = canvas.getContext('2d');

        // clear
        c.clearRect(0, 0, canvas.width, canvas.height);

        c.fillStyle = "red";
        c.strokeStyle = "black";

        // draw the current path
        if(mousedown){
            c.beginPath();
            for(var i=0; i<path.length-1; i++){
                c.moveTo(path[i][0],path[i][1]);
                c.lineTo(path[i+1][0],path[i+1][1]);
            }
            c.fill();
            c.stroke();

            for(var i=0; i<path.length-1; i++){
                c.beginPath();
                c.arc(path[i][0],path[i][1],2,0,2*Math.PI);
                c.fill();
            }
        }

        // Draw the convex decomp if it exists
        for(var i=0; i<polys.length; i++){
            c.fillStyle = colors[i%(colors.length)];
            var poly = polys[i];
            c.beginPath();
            var p = poly.vertices[0];
            c.moveTo(p[0],p[1]);
            for(var j=0; j<poly.vertices.length; j++){
                var p = poly.vertices[j];
                c.lineTo(p[0],p[1]);
            }
            c.closePath();
            c.fill();
        }

        // Draw points
        c.fillStyle = "black";
        for(var i=0; i<polys.length; i++){
            var poly = polys[i];
            for(var j=0; j<poly.vertices.length; j++){
                var p = poly.vertices[j];
                c.beginPath();
                c.arc(p[0],p[1],1,0,2*Math.PI);
                c.fill();
            }
        }
    }
    render();

    // Setup GUI
    var settings = {
        minEdgeLength : 50,
        quickDecomp : true,
    };
    var gui = new dat.GUI();
    gui.add(settings, 'minEdgeLength', 1, 100);
    gui.add(settings, 'quickDecomp');

    function getMousePos(e){
        var offset = $("canvas").offset();
        return [e.clientX + offset.left,e.clientY + offset.top];
    }

    $("canvas").mousedown(function(e){
        path = [];
        polys = [];
        path.push(getMousePos(e));
        mousedown = true;
        render();
    }).mousemove(function(e){
        var point = getMousePos(e);
        if(mousedown && decomp.Point.sqdist(point,path[path.length-1])>settings.minEdgeLength*settings.minEdgeLength){
            path.push(point);
            render();
        }
    }).mouseup(function(e){
        mousedown = false;
        var p = new decomp.Polygon();
        p.vertices = path;
        if(p.isSimple()){
            p.makeCCW();
            console.log("Decomposing polygon of size "+path.length+"...");
            console.log("Slicing the polygon...");
            if(settings.quickDecomp)
                polys = p.quickDecomp();
            else
                polys = p.decomp();
            console.log("Got "+polys.length+" slices. Done.");
        } else {
            console.log("The polygon was not simple. Aborting...");
        }
        path = [];
        render();
    });

    </script>
</body>
</html>
